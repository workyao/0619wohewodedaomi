<!--pages/square/square.wxml-->
<view class="page-container desert-pattern">
  <!-- é¡¶éƒ¨æœç´¢å’Œç­›é€‰ -->
  <view class="search-section">
    <view class="search-bar">
      <input 
        class="search-input" 
        placeholder="æœç´¢ç¨»ç±³åŠ¨æ€..." 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
      />
      <button class="search-btn" bindtap="onSearch">ğŸ”</button>
    </view>
    
    <view class="filter-tabs">
      <view 
        class="filter-tab {{currentFilter === item.key ? 'active' : ''}}"
        wx:for="{{filterOptions}}" 
        wx:key="key"
        bindtap="switchFilter"
        data-filter="{{item.key}}"
      >
        <text class="tab-icon">{{item.icon}}</text>
        <text class="tab-label">{{item.name}}</text>
      </view>
    </view>
  </view>

  <!-- åŠ¨æ€åˆ—è¡¨ -->
  <view class="activities-section">
    <view class="activities-list">
      <view 
        class="activity-card card"
        wx:for="{{activities}}" 
        wx:key="id"
      >
        <view class="card-body">
          <!-- ç”¨æˆ·ä¿¡æ¯ -->
          <view class="user-header">
            <image class="avatar avatar-medium" src="{{item.userAvatar}}" mode="aspectFill"></image>
            <view class="user-info">
              <text class="user-name">{{item.userName}}</text>
              <text class="activity-time">{{item.timeAgo}}</text>
            </view>
            <view class="activity-type">
              <text class="type-badge">{{item.typeName}}</text>
            </view>
          </view>

          <!-- æ‰“å¡å†…å®¹ -->
          <view class="activity-content" wx:if="{{item.type === 'checkin'}}">
            <text class="activity-desc">{{item.action}}</text>
            
            <!-- é€‰æ‹©çš„æ­Œæ›² -->
            <view class="songs-list" wx:if="{{item.data.songs && item.data.songs.length > 0}}">
              <view 
                class="song-tag"
                wx:for="{{item.data.songs}}" 
                wx:key="id"
                wx:for-item="song"
                bindtap="goToSongDetail"
                data-song-id="{{song.id}}"
              >
                ğŸµ {{song.title}}
              </view>
            </view>

            <!-- å¿ƒæƒ…å’Œå¤‡æ³¨ -->
            <view class="mood-note" wx:if="{{item.data.mood || item.data.note}}">
              <view class="mood" wx:if="{{item.data.mood}}">
                <text class="mood-emoji">{{item.data.moodEmoji}}</text>
                <text class="mood-text">{{item.data.moodText}}</text>
              </view>
              <text class="note" wx:if="{{item.data.note}}">{{item.data.note}}</text>
            </view>
          </view>

          <!-- äº’åŠ¨åŒºåŸŸ -->
          <view class="interaction-area">
            <view class="interaction-stats">
              <text class="stat-item">
                <text class="stat-icon">ğŸ‘</text>
                <text class="stat-count">{{item.likesCount || 0}}</text>
              </text>
              <text class="stat-item">
                <text class="stat-icon">ğŸ’¬</text>
                <text class="stat-count">{{item.commentsCount || 0}}</text>
              </text>
              <text class="stat-item">
                <text class="stat-icon">ğŸ”„</text>
                <text class="stat-count">{{item.sharesCount || 0}}</text>
              </text>
            </view>
            
            <view class="interaction-buttons">
              <button 
                class="interaction-btn {{item.isLiked ? 'liked' : ''}}"
                bindtap="toggleLike"
                data-activity-id="{{item.id}}"
              >
                <text class="btn-icon">{{item.isLiked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
                <text class="btn-text">ç‚¹èµ</text>
              </button>
              
              <button 
                class="interaction-btn"
                bindtap="showComments"
                data-activity-id="{{item.id}}"
              >
                <text class="btn-icon">ğŸ’¬</text>
                <text class="btn-text">è¯„è®º</text>
              </button>
              
              <button 
                class="interaction-btn"
                bindtap="shareActivity"
                data-activity="{{item}}"
              >
                <text class="btn-icon">ğŸ”„</text>
                <text class="btn-text">åˆ†äº«</text>
              </button>
            </view>
          </view>

          <!-- è¯„è®ºé¢„è§ˆ -->
          <view class="comments-preview" wx:if="{{item.recentComments && item.recentComments.length > 0}}">
            <view 
              class="comment-item"
              wx:for="{{item.recentComments}}" 
              wx:key="id"
              wx:for-item="comment"
            >
              <text class="comment-user">{{comment.userName}}</text>
              <text class="comment-content">{{comment.content}}</text>
            </view>
            <text 
              class="view-all-comments"
              bindtap="showComments"
              data-activity-id="{{item.id}}"
              wx:if="{{item.commentsCount > item.recentComments.length}}"
            >
              æŸ¥çœ‹å…¨éƒ¨{{item.commentsCount}}æ¡è¯„è®º
            </text>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore}}">
      <button class="btn btn-outline" bindtap="loadMore" disabled="{{loading}}">
        {{loading ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}
      </button>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{activities.length === 0 && !loading}}">
      <text class="empty-icon">ğŸŒ¾</text>
      <text class="empty-text">æš‚æ— åŠ¨æ€</text>
      <text class="empty-desc">å¿«å»æ‰“å¡åˆ†äº«ä½ çš„éŸ³ä¹å¿ƒæƒ…å§</text>
      <button class="btn btn-primary" bindtap="goToCheckin">å»æ‰“å¡</button>
    </view>
  </view>

  <!-- å‘å¸ƒæŒ‰é’® -->
  <view class="fab-container">
    <button class="fab" bindtap="goToCheckin">
      <text class="fab-icon">âœï¸</text>
    </button>
  </view>
</view>

<!-- åŠ è½½é®ç½© -->
<view class="loading-mask" wx:if="{{loading && activities.length === 0}}">
  <view class="loading-content">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>
