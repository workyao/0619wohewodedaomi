# 部署指南

本文档详细说明如何部署"我和我的稻米朋友们"微信小程序。

## 前置条件

### 1. 微信小程序账号
- 注册微信小程序账号：https://mp.weixin.qq.com/
- 获取小程序的 AppID
- 配置小程序基本信息（名称、头像、简介等）

### 2. 开发工具
- 下载微信开发者工具：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html
- 安装并登录微信开发者工具

### 3. 云开发环境
- 在微信公众平台开通云开发服务
- 创建云开发环境（建议创建两个环境：开发环境和生产环境）

## 部署步骤

### 第一步：项目配置

1. **配置 AppID**
   ```json
   // project.config.json
   {
     "appid": "你的小程序AppID",
     "projectname": "我和我的稻米朋友们"
   }
   ```

2. **配置云环境ID**
   ```javascript
   // app.js
   wx.cloud.init({
     env: '你的云环境ID', // 替换为实际的环境ID
     traceUser: true,
   })
   ```

### 第二步：云函数部署

1. **在微信开发者工具中右键点击 `cloudfunctions` 目录**
2. **选择"当前环境"，切换到目标云环境**
3. **逐个部署云函数：**

   - **login 云函数**
     - 右键 `cloudfunctions/login` 目录
     - 选择"上传并部署：云端安装依赖"
     
   - **checkin 云函数**
     - 右键 `cloudfunctions/checkin` 目录
     - 选择"上传并部署：云端安装依赖"
     
   - **songs 云函数**
     - 右键 `cloudfunctions/songs` 目录
     - 选择"上传并部署：云端安装依赖"
     
   - **social 云函数**
     - 右键 `cloudfunctions/social` 目录
     - 选择"上传并部署：云端安装依赖"
     
   - **initData 云函数**
     - 右键 `cloudfunctions/initData` 目录
     - 选择"上传并部署：云端安装依赖"

### 第三步：数据库初始化

1. **在微信开发者工具的调试器中执行：**
   ```javascript
   wx.cloud.callFunction({
     name: 'initData',
     data: {
       action: 'initAll'
     }
   }).then(res => {
     console.log('数据初始化结果：', res)
   })
   ```

2. **验证数据库集合是否创建成功：**
   - 在云开发控制台查看数据库
   - 确认以下集合已创建：
     - `users` - 用户信息
     - `songs` - 歌曲数据
     - `categories` - 歌曲分类
     - `checkins` - 打卡记录
     - `activities` - 用户动态
     - `likes` - 点赞记录
     - `comments` - 评论记录
     - `follows` - 关注关系

### 第四步：数据库权限配置

在云开发控制台的数据库权限设置中，为每个集合配置适当的权限：

1. **users 集合**
   ```json
   {
     "read": "auth.openid == resource.openid",
     "write": "auth.openid == resource.openid"
   }
   ```

2. **songs 和 categories 集合**
   ```json
   {
     "read": true,
     "write": false
   }
   ```

3. **checkins 集合**
   ```json
   {
     "read": "auth.openid == resource.openid",
     "write": "auth.openid == resource.openid"
   }
   ```

4. **activities 集合**
   ```json
   {
     "read": true,
     "write": "auth.openid == resource.openid"
   }
   ```

5. **likes、comments、follows 集合**
   ```json
   {
     "read": true,
     "write": "auth.openid == resource.openid"
   }
   ```

### 第五步：云存储配置（可选）

如果需要上传图片或文件功能：

1. **在云开发控制台开通云存储**
2. **配置存储权限**
3. **在代码中使用云存储API**

### 第六步：本地测试

1. **在微信开发者工具中预览小程序**
2. **测试核心功能：**
   - 用户登录
   - 歌曲列表加载
   - 打卡功能
   - 动态广场
   - 个人资料

3. **检查云函数调用是否正常**
4. **检查数据库读写是否正常**

### 第七步：真机测试

1. **点击微信开发者工具的"预览"按钮**
2. **使用微信扫码在真机上测试**
3. **测试各项功能在真机上的表现**
4. **检查性能和用户体验**

### 第八步：提交审核

1. **完善小程序信息：**
   - 在微信公众平台设置小程序名称、头像、简介
   - 配置服务类别
   - 上传小程序截图

2. **代码上传：**
   - 在微信开发者工具中点击"上传"
   - 填写版本号和项目备注
   - 确认上传成功

3. **提交审核：**
   - 在微信公众平台的"版本管理"中找到刚上传的版本
   - 点击"提交审核"
   - 填写审核信息和功能说明

4. **等待审核结果**

### 第九步：发布上线

1. **审核通过后，在微信公众平台点击"发布"**
2. **确认发布信息**
3. **小程序正式上线**

## 环境管理

### 开发环境
- 用于日常开发和测试
- 可以随意修改数据
- 云函数可以频繁更新

### 生产环境
- 用于正式发布的小程序
- 数据需要谨慎处理
- 云函数更新需要充分测试

### 环境切换
在 `app.js` 中通过修改 `env` 参数切换环境：
```javascript
wx.cloud.init({
  env: process.env.NODE_ENV === 'production' ? 'prod-env-id' : 'dev-env-id',
  traceUser: true,
})
```

## 监控和维护

### 1. 云开发控制台监控
- 定期查看云函数调用情况
- 监控数据库读写次数
- 检查云存储使用量

### 2. 小程序数据分析
- 在微信公众平台查看用户访问数据
- 分析用户行为和留存率
- 根据数据优化功能

### 3. 用户反馈处理
- 建立用户反馈渠道
- 及时处理用户问题
- 根据反馈优化产品

## 常见问题

### 1. 云函数调用失败
- 检查云函数是否正确部署
- 确认云环境ID是否正确
- 查看云函数日志排查错误

### 2. 数据库权限问题
- 检查数据库权限配置
- 确认用户是否正确登录
- 验证openid是否正确传递

### 3. 小程序审核被拒
- 仔细阅读审核意见
- 根据要求修改代码
- 完善小程序资质和说明

### 4. 性能问题
- 优化图片大小和格式
- 减少不必要的网络请求
- 使用小程序性能分析工具

## 成本控制

### 1. 云开发资源优化
- 合理设置云函数超时时间
- 优化数据库查询效率
- 控制云存储使用量

### 2. 免费额度利用
- 充分利用云开发免费额度
- 监控资源使用情况
- 避免不必要的资源浪费

### 3. 按需扩容
- 根据用户增长情况调整资源配置
- 选择合适的付费套餐
- 定期评估成本效益

## 备份和恢复

### 1. 数据备份
- 定期导出重要数据
- 建立数据备份策略
- 测试数据恢复流程

### 2. 代码版本管理
- 使用Git管理代码版本
- 建立代码发布流程
- 保留历史版本以便回滚

---

如有问题，请联系技术支持：support@daomifriends.com
